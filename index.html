<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>eVocal Studio ‚Äî Caja V4</title>

<style>
:root{
  --paper-width:72mm;
  --bg:#fafafa;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#0b1720;
  --primary:#0b84ff;
  --danger:#dc2626;
  --border:#e6e9ee;
  --radius:10px;
  --pad:14px;
  font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--accent);font-size:14px}
.header{background:var(--card);border-bottom:1px solid var(--border);padding:16px var(--pad);display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:800;font-size:18px}
.header .meta{color:var(--muted);font-size:13px}
.container{max-width:1100px;margin:18px auto;padding:0 var(--pad)}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tab{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:700}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 14px rgba(2,6,23,0.03)}
.section-title{font-weight:800;margin-bottom:10px;color:var(--accent);font-size:15px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--accent)}
.button{padding:10px 12px;border-radius:10px;border:0;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
.link-btn{background:transparent;border:1px dashed var(--border);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
.small-muted{color:var(--muted);font-size:13px}
.mov-list{max-height:360px;overflow:auto;border-radius:8px;border:1px solid var(--border);padding:8px;background:#fff}
.mov-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px dashed var(--border)}
.mov-head{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;font-weight:800;border-bottom:1px solid var(--border);margin-bottom:8px;color:var(--accent)}
.ticket{width:var(--paper-width);background:#fff;padding:18px;margin:14px auto;border-radius:10px;border:1px solid #ddd;font-family:Arial,Helvetica,sans-serif}
.ticket *{color:#000}
.dots{text-align:center;color:#444;letter-spacing:1px;margin:10px 0;font-size:12px}
.footer-legal{font-size:9px;color:#444;white-space:pre-wrap;margin-top:10px}
.signature-line{width:80%;border-bottom:3px solid #000;height:2px;margin:12px auto}
.centered-caption{text-align:center;font-size:12px;color:#444;margin-top:6px}
@media print{
  body{background:transparent}
  .tabs,.header,.container .card .button,.link-btn,.users-list,.mov-list{display:none}
  .ticket{box-shadow:none;margin:0}
  @page{size:var(--paper-width) auto;margin:0}
}
</style>
</head>
<body>
  <div class="header">
    <div>
      <div class="brand">eVocal Studio</div>
      <div class="meta small-muted" id="currentShiftDisplay">‚Äî</div>
    </div>
    <div style="text-align:right">
      <div id="userDisplay" class="small-muted">No autenticado</div>
      <div id="shiftTimer" class="small-muted">‚Äî</div>
      <div id="sessionActions" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="container">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="access">Acceso</div>
      <div class="tab" data-tab="cash" style="display:none">Caja</div>
      <div class="tab" data-tab="venta" style="display:none">Venta</div>
      <div class="tab" data-tab="calc" style="display:none">Calculadora</div>
      <div class="tab" data-tab="users" style="display:none">Usuarios</div>
      <div class="tab" data-tab="forgot" style="display:none">Olvid√© PIN</div>
      <div class="tab" data-tab="history" style="display:none">Historial / Cierres</div>
    </div>

    <!-- ACCESS -->
    <div class="card" id="tab-access">
      <div class="section-title">Acceso / Abrir turno</div>
      <div class="grid">
        <div>
          <label>PIN</label>
          <input type="password" id="pinLogin" placeholder="Ingresa tu PIN" autocomplete="off">
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="button" id="btnLogin">Entrar / Abrir turno</button>
            <button class="link-btn" onclick="simulateTime()">Simular hora</button>
            <button class="link-btn" onclick="goToForgot()">Olvid√© PIN</button>
            <button class="link-btn" onclick="resetGeneral()">Reset general</button>
          </div>
          <div class="small-muted" style="margin-top:8px">Al abrir la caja se cargar√° el monto entregado por el turno anterior (si existe) para la conciliaci√≥n.</div>
        </div>
        <div>
          <label>Turno detectado</label>
          <div class="small-muted" id="detectedShift">‚Äî</div>
          <label style="margin-top:10px">Turno (manual si fuera de horario)</label>
          <select id="manualTurno">
            <option value="M">Matutino (09:00‚Äì15:00)</option>
            <option value="V">Vespertino (15:00‚Äì21:00)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div style="margin-top:14px" class="grid">
      <div>
        <div class="card" id="tab-cash" style="display:none">
          <div class="section-title">Caja ‚Äî Movimientos (efectivo)</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <label>Tipo</label>
              <select id="movTipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select>

              <label style="margin-top:8px">Concepto</label>
              <select id="movConcepto">
                <option>Reembolso</option>
                <option>Compra autorizada</option>
                <option>Otro</option>
              </select>
              <label id="customConceptLabel" style="display:none;margin-top:8px">Concepto personalizado (si marca Otro)</label>
              <input type="text" id="movConceptoCustom" style="display:none" placeholder="Especifica concepto">
              <div class="small-muted" style="margin-top:10px" id="previousDeliveredNote"></div>
            </div>

            <div style="flex:1;min-width:220px">
              <label>Monto ($)</label>
              <input type="number" id="movMonto" step="0.01" placeholder="0.00">
              <label style="margin-top:8px">Nota (opcional)</label>
              <input type="text" id="movNota" placeholder="Comentario breve">
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="button" onclick="addMovement()">Agregar</button>
                <button class="link-btn" onclick="clearMovementForm()">Limpiar</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="mov-head">
              <div>MOVIMIENTOS</div>
              <div class="small-muted">Concepto ¬∑¬∑¬∑¬∑ Monto</div>
            </div>
            <div class="mov-list" id="movementsList"><em>Sin movimientos</em></div>

            <div style="margin-top:10px">
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px dashed var(--border)"><div>Total efectivo</div><div id="sumEfectivo">$0.00</div></div>
              <div style="display:flex;justify-content:space-between;padding:8px 0"><div><strong>Total ingresos</strong></div><div id="sumIngresos">$0.00</div></div>
              <div style="display:flex;justify-content:space-between;padding:8px 0"><div><strong>Total egresos</strong></div><div id="sumEgresos">$0.00</div></div>
              <div style="display:flex;justify-content:space-between;padding:8px 0"><div><strong>Balance</strong></div><div id="sumBalance">$0.00</div></div>
            </div>
          </div>
        </div>

        <div class="card" id="tab-venta" style="display:none;margin-top:14px">
          <div class="section-title">Venta ‚Äî Registrar pago</div>
          <div style="display:grid;gap:8px">
            <label>Alumno / Cliente</label>
            <input type="text" id="ventaCliente" placeholder="Nombre del alumno o cliente">
            <label>Matr√≠cula</label>
            <input type="text" id="ventaMatricula" placeholder="Matr√≠cula (opcional)">
            <label>Descripci√≥n</label>
            <input type="text" id="ventaDescripcion" placeholder="Concepto o detalle">
            <div style="display:flex;gap:8px">
              <div style="flex:1"><label>Monto (incluye IVA) ($)</label><input type="number" id="ventaMonto" step="0.01" placeholder="0.00"></div>
              <div style="width:160px"><label>Descuento ($)</label><input type="number" id="ventaDescuento" step="0.01" value="0"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="button" onclick="registerSale({card:false})">Registrar e imprimir (Efectivo)</button>
              <button class="button" onclick="registerSale({card:true})">Imprimir (Tarjeta)</button>
              <button class="link-btn" onclick="clearSaleForm()">Limpiar</button>
            </div>
            <div class="small-muted">El monto ingresado incluye IVA (16%). El descuento se aplica sobre la base antes de IVA.</div>
          </div>
        </div>

        <div class="card" id="tab-calc" style="display:none;margin-top:14px">
          <div class="section-title">Calculadora de denominaciones</div>
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <div style="display:grid;grid-template-columns:1fr 120px;gap:8px">
                <div><label>$1,000</label><input type="number" id="d1000" min="0" value="0"></div>
                <div><label>$500</label><input type="number" id="d500" min="0" value="0"></div>
                <div><label>$200</label><input type="number" id="d200" min="0" value="0"></div>
                <div><label>$100</label><input type="number" id="d100" min="0" value="0"></div>
                <div><label>$50</label><input type="number" id="d50" min="0" value="0"></div>
                <div><label>$20</label><input type="number" id="d20" min="0" value="0"></div>
                <div><label>$10</label><input type="number" id="d10" min="0" value="0"></div>
                <div><label>$5</label><input type="number" id="d5" min="0" value="0"></div>
                <div><label>$2</label><input type="number" id="d2" min="0" value="0"></div>
                <div><label>$1</label><input type="number" id="d1" min="0" value="0"></div>
                <div><label>$0.50</label><input type="number" id="d050" min="0" value="0"></div>
              </div>
            </div>
            <div style="width:220px">
              <label>Total contado</label>
              <div style="font-size:20px;font-weight:700;margin:8px 0" id="totalCounted">$0.00</div>
              <div style="display:flex;gap:8px">
                <button class="button" onclick="calculateDenominations()">Calcular</button>
                <button class="link-btn" onclick="saveDenominations()">Guardar conteo</button>
              </div>
              <div style="margin-top:10px">
                <div class="small-muted">Efectivo declarado</div>
                <div style="font-weight:700" id="efectivoDeclarado">$0.00</div>
                <div class="small-muted" style="margin-top:8px">Diferencia</div>
                <div style="font-weight:700;color:var(--danger)" id="diferenciaEfectivo">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" id="tab-usersCard" style="display:none">
          <div class="section-title">Usuarios</div>
          <div style="display:flex;gap:8px">
            <div style="flex:1">
              <label>Nombre</label>
              <input type="text" id="newName" placeholder="Nombre completo">
              <label style="margin-top:8px">Rol</label>
              <select id="newRole"><option value="frontdesk">Front Desk</option><option value="encargado">Encargado</option><option value="direccion">Direcci√≥n</option></select>
              <label style="margin-top:8px">PIN (4-8 d√≠gitos)</label>
              <input type="password" id="newPin" placeholder="PIN num√©rico">
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="button" onclick="createUser()">Crear usuario</button>
                <button class="link-btn" onclick="loadUsers()">Refrescar</button>
              </div>
            </div>
            <div style="flex:1">
              <label>Usuarios registrados</label>
              <div class="mov-list" id="usersList"></div>
            </div>
          </div>
        </div>

        <div class="card" id="tab-forgotCard" style="display:none;margin-top:12px">
          <div class="section-title">Olvid√© PIN ‚Äî Solicitar restablecimiento</div>
          <label>Tu nombre</label>
          <input type="text" id="forgotName" placeholder="Nombre exacto">
          <label style="margin-top:8px">Motivo</label>
          <input type="text" id="forgotReason" placeholder="Ej: Olvid√© PIN, cambio necesario">
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="button" onclick="requestForgot()">Enviar solicitud</button>
            <button class="link-btn" onclick="loadResetRequests()">Ver solicitudes</button>
          </div>
          <div id="resetRequests" style="margin-top:10px" class="mov-list"></div>
        </div>

        <div class="card" id="tab-historyCard" style="display:none;margin-top:12px">
          <div class="section-title">Historial de turnos</div>
          <div id="turnHistory" class="mov-list"></div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="button" onclick="exportDailyReport()">Reporte diario (visual)</button>
            <button class="button" onclick="exportMonthlyReport()">Reporte mensual</button>
            <button class="button" onclick="exportAnnualReport()">Reporte anual</button>
            <button class="link-btn" onclick="printTicket()">Imprimir ticket (72 mm)</button>
            <button class="link-btn" onclick="closeTurn()">Cerrar turno</button>
            <button class="link-btn" onclick="exportCSV()">Exportar CSV</button>
            <button class="link-btn" onclick="closeMonthly()">Cierre mensual</button>
            <button class="link-btn" onclick="closeAnnual()">Cierre anual (23 Dic)</button>
          </div>
          <div class="small-muted" style="margin-top:8px">Al cerrar un turno se guardar√° el monto final entregado y la Caja / Calculadora quedar√°n bloqueadas hasta nuevo turno.</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ===========================
   Firebase modular imports
   =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc,
  onSnapshot, orderBy, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ===========================
   Firebase config (usando tu config)
   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyDtMNrHgn9rK329qMNVWoj7TDVJ-RdtYnQ",
  authDomain: "evocal-caja.firebaseapp.com",
  projectId: "evocal-caja",
  storageBucket: "evocal-caja.firebasestorage.app",
  messagingSenderId: "640392902121",
  appId: "1:640392902121:web:a586ae422a0a908b1c0778"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
console.log("üî• Firebase inicializado correctamente");

/* ===========================
   Utilities
   =========================== */
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9) }
function money(n){ return "$" + Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2, maximumFractionDigits:2}) }
function fmtShort(d){ const D=new Date(d); return `${String(D.getDate()).padStart(2,'0')}/${String(D.getMonth()+1).padStart(2,'0')}/${D.getFullYear()}` }
function fmtTime(d){ const D=new Date(d); return `${String(D.getHours()).padStart(2,'0')}:${String(D.getMinutes()).padStart(2,'0')}:${String(D.getSeconds()).padStart(2,'0')}` }

/* ===========================
   Hierarchy helpers
   /years/{year}/months/{month}/days/{day}/turnos/{turn}/...
   =========================== */
function partsFromDate(d){
  const D = new Date(d);
  return { year: String(D.getFullYear()), month: String(D.getMonth()+1).padStart(2,'0'), day: String(D.getDate()).padStart(2,'0') };
}
function turnDocRefFrom(date, turno){
  const p = partsFromDate(date);
  return doc(db, `years/${p.year}/months/${p.month}/days/${p.day}/turnos/${turno}`);
}
function collRefFor(date, turno, collName){
  const p = partsFromDate(date);
  return collection(db, `years/${p.year}/months/${p.month}/days/${p.day}/turnos/${turno}/${collName}`);
}
function docRefForTurnId(turnId){
  const day = turnId.slice(0,2), month = turnId.slice(2,4), year = turnId.slice(4,8), turno = turnId.slice(8);
  return doc(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}`);
}

/* ===========================
   Seed users (only if none)
   =========================== */
async function ensureUsersSeed(){
  const q = query(collection(db,'users'), where('name','!=',''));
  const r = await getDocs(q);
  if(!r.empty) return;
  try{
    await addDoc(collection(db,'users'), { name:'Jair P√©rez', roles:['encargado','frontdesk','direccion'], pin:'2831' });
    await addDoc(collection(db,'users'), { name:'Direcci√≥n', roles:['direccion'], pin:'9999' });
    console.log('Usuarios semilla creados');
  }catch(e){ console.warn('No se pudo crear seed users', e); }
}
ensureUsersSeed();

/* ===========================
   Session & shift detection
   =========================== */
let session = null;
function detectShift(dt=new Date()){
  const h = dt.getHours();
  // Matutino 09:00‚Äì15:00, Vespertino 15:00‚Äì21:00
  if(h>=9 && h<15) return 'M';
  if(h>=15 && h<21) return 'V';
  return null;
}
function createTurnId(d, turno){
  const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); const suf = turno==='M'?'MAT':'VES'; return `${dd}${mm}${yyyy}${suf}`;
}
function displayShift(){ const s=detectShift(new Date()); document.getElementById('detectedShift').textContent = s==='M' ? 'Matutino' : (s==='V' ? 'Vespertino' : 'Fuera de horario'); document.getElementById('currentShiftDisplay').textContent = `Hora: ${fmtShort(new Date())} ${fmtTime(new Date())}`; updateCountdown(); }
displayShift();
setInterval(displayShift,1000);

/* Tabs */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', ()=> {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name=t.dataset.tab;
  document.getElementById('tab-access').style.display = name==='access' ? '' : 'none';
  document.getElementById('tab-cash').style.display = name==='cash' ? '' : 'none';
  document.getElementById('tab-venta').style.display = name==='venta' ? '' : 'none';
  document.getElementById('tab-calc').style.display = name==='calc' ? '' : 'none';
  document.getElementById('tab-usersCard').style.display = name==='users' ? '' : 'none';
  document.getElementById('tab-forgotCard').style.display = name==='forgot' ? '' : 'none';
  document.getElementById('tab-historyCard').style.display = name==='history' ? '' : 'none';
  refreshAll();
}));

/* Login with Enter */
document.getElementById('pinLogin').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleLogin(); }});
document.getElementById('btnLogin').addEventListener('click', handleLogin);

/* Helper: find user by PIN */
async function findUserByPin(pin){
  const q = query(collection(db,'users'), where('pin','==',pin));
  const snap = await getDocs(q);
  if(snap.empty) return null;
  const d = snap.docs[0]; return { id: d.id, ...d.data() };
}

/* Realtime unsub handles */
let movementsUnsub = null, ventasUnsub = null, turnUnsub = null;

/* Handle login: open or attach to turn (hierarchy) */
async function handleLogin(){
  const pin = document.getElementById('pinLogin').value.trim();
  if(!pin) return alert('Ingresa PIN.');
  const user = await findUserByPin(pin);
  if(!user) return alert('PIN no reconocido.');
  session = { userId: user.id, name: user.name, roles: user.roles || [] };
  document.getElementById('userDisplay').textContent = session.name;
  document.getElementById('pinLogin').value='';
  document.getElementById('sessionActions').innerHTML = `<button class="link-btn" onclick="logout()">Cerrar sesi√≥n</button>`;
  let shift = detectShift(new Date());
  if(!shift) shift = document.getElementById('manualTurno').value; else document.getElementById('manualTurno').value = shift;

  const now = new Date();
  const parts = partsFromDate(now);
  const turnoName = shift === 'M' ? 'MAT' : 'VES';
  const turnDocPath = `years/${parts.year}/months/${parts.month}/days/${parts.day}/turnos/${turnoName}`;
  const turnDoc = doc(db, turnDocPath);
  const tSnap = await getDoc(turnDoc);
  if(tSnap.exists() && tSnap.data().status === 'open'){
    // attach
    session.turnId = createTurnId(now, shift);
    session.canOperate = (tSnap.data().encargadoId === session.userId) || session.roles.includes('encargado') || session.roles.includes('direccion') || session.name==='Jair P√©rez';
    showTabsAfterOpen();
    subscribeRealtime(session.turnId);
    updateUIForSession(); refreshAll();
    return;
  }

  // create new turn
  const turnId = createTurnId(now, shift);
  const newTurn = { id: turnId, shift, encargadoId: session.userId, encargadoName: session.name, status:'open', openedAt: new Date().toISOString(), previousDelivered:null };
  try{
    await setDoc(turnDoc, newTurn);
    session.turnId = turnId;
    session.canOperate = true;
    showTabsAfterOpen();
    subscribeRealtime(session.turnId);
    updateUIForSession(); refreshAll();
  }catch(e){
    console.error('Error creando turno', e); alert('No se pudo crear turno en Firestore.');
  }
}

function showTabsAfterOpen(){
  document.querySelectorAll('.tab').forEach(t=>{ if(t.dataset.tab!=='access') t.style.display = ''; });
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.tab[data-tab="cash"]').classList.add('active');
  document.getElementById('tab-access').style.display='none';
  document.getElementById('tab-cash').style.display='';
  document.getElementById('tab-venta').style.display='';
  document.getElementById('tab-calc').style.display='';
  document.getElementById('tab-forgotCard').style.display='';
  document.getElementById('tab-historyCard').style.display='';
}
function logout(){
  if(movementsUnsub){ movementsUnsub(); movementsUnsub = null; }
  if(ventasUnsub){ ventasUnsub(); ventasUnsub = null; }
  if(turnUnsub){ turnUnsub(); turnUnsub = null; }
  session=null; document.getElementById('userDisplay').textContent='No autenticado'; document.getElementById('sessionActions').innerHTML=''; updateUIForSession();
}

/* Realtime subscriptions */
function subscribeRealtime(turnId){
  if(movementsUnsub) movementsUnsub();
  if(ventasUnsub) ventasUnsub();
  if(turnUnsub) turnUnsub();

  const day = turnId.slice(0,2), month = turnId.slice(2,4), year = turnId.slice(4,8), turno = turnId.slice(8);
  const turnPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}`;
  const turnRef = doc(db, turnPath);

  turnUnsub = onSnapshot(turnRef, snap => {
    if(!snap.exists()) return;
    const data = snap.data();
    const prev = data.previousDelivered;
    document.getElementById('previousDeliveredNote').innerText = prev ? 'Monto entregado por turno anterior: ' + money(prev) : '';
    if(data.status === 'closed' && session && session.turnId === turnId) {
      session.canOperate = false;
      alert('Este turno ha sido cerrado (actualizado desde otra m√°quina).');
      updateUIForSession();
    }
    refreshTurnHistory();
  });

  const movColl = collection(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos`);
  const qMov = query(movColl, orderBy('createdAt','desc'));
  movementsUnsub = onSnapshot(qMov, snap=>{
    const moves = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderMovements(moves);
  });

  const vColl = collection(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}/ventas`);
  const qV = query(vColl, orderBy('createdAt','desc'));
  ventasUnsub = onSnapshot(qV, snap=>{
    // for UI updates; refresh history
    refreshTurnHistory();
  });
}

/* Movements */
function clearMovementForm(){
  document.getElementById('movMonto').value=''; document.getElementById('movNota').value=''; document.getElementById('movConceptoCustom').value=''; document.getElementById('movConceptoCustom').style.display='none'; document.getElementById('customConceptLabel').style.display='none'; document.getElementById('movConcepto').value='Reembolso'; document.getElementById('movTipo').value='ingreso';
}
document.getElementById('movConcepto').addEventListener('change', (e)=>{ if(e.target.value==='Otro'){ document.getElementById('movConceptoCustom').style.display=''; document.getElementById('customConceptLabel').style.display=''; } else { document.getElementById('movConceptoCustom').style.display='none'; document.getElementById('customConceptLabel').style.display='none' } });

async function addMovement(){
  if(!session || !session.turnId) return alert('Debes iniciar sesi√≥n y tener turno abierto.');
  const tipo = document.getElementById('movTipo').value;
  let concepto = document.getElementById('movConcepto').value;
  let protectedFlag = false;
  if(concepto==='Otro'){ const c=document.getElementById('movConceptoCustom').value.trim(); if(!c) return alert('Escribe el concepto personalizado.'); concepto=c; protectedFlag=true; alert('‚ö†Ô∏è Movimiento "Otro": solo podr√° editarse, no eliminarse.'); }
  const montoRaw = parseFloat(document.getElementById('movMonto').value) || 0;
  const monto = Number(Math.round(montoRaw));
  if(monto<=0) return alert('Monto inv√°lido.');
  const nota = document.getElementById('movNota').value.trim();

  const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
  const collPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos`;
  const move = { id: uid('m'), turnoId: session.turnId, createdBy: session.userId, creatorName: session.name, tipo, metodo:'efectivo', concepto, nota, monto, createdAt: new Date().toISOString(), protected: protectedFlag };
  try{
    await setDoc(doc(db, collPath, move.id), move);
    clearMovementForm();
    refreshTurnHistory();
  }catch(e){ console.error('Error guardando movimiento', e); alert('No se pudo guardar en la nube. Revisa conexi√≥n.'); }
}

function renderMovements(moves){
  const list = document.getElementById('movementsList');
  if(!moves || moves.length===0){ list.innerHTML='<em>Sin movimientos</em>'; updateSums(0,0,0,0); return; }
  list.innerHTML = moves.map(m=>{
    const prot = m.protected ? '<span style="background:#fff4e6;color:#7a4b00;padding:4px;border-radius:6px;margin-left:6px;font-weight:700">OTRO</span>':'';
    const amountAligned = m.tipo==='ingreso' ? `<div style="min-width:120px;text-align:right">${money(m.monto)}</div>` : `<div style="min-width:120px;text-align:left">${money(m.monto)}</div>`;
    const editBtn = (session && (session.userId===m.createdBy || session.name==='Jair P√©rez' || (session.roles && session.roles.includes('direccion')))) ? `<button onclick="editMovement('${m.id}')">Editar</button>` : '';
    const delBtn = (!m.protected && session && (session.userId===m.createdBy || session.name==='Jair P√©rez' || (session.roles && session.roles.includes('direccion')))) ? `<button onclick="deleteMovement('${m.id}')">Eliminar</button>` : '';
    return `<div class="mov-row"><div style="flex:1"><strong>${m.tipo.toUpperCase()}</strong> ‚Äî ${m.concepto} ${prot}<div class="small-muted">${m.nota||''}</div></div>${amountAligned}<div style="min-width:140px;text-align:right;margin-left:8px">${editBtn} ${delBtn}</div></div>`;
  }).join('');
  let sumEf=0,sumIng=0,sumEgr=0;
  moves.forEach(m=>{ sumEf += (m.tipo==='ingreso'?m.monto:-m.monto); if(m.tipo==='ingreso') sumIng+=m.monto; if(m.tipo==='egreso') sumEgr+=m.monto; });
  updateSums(sumEf,sumIng,sumEgr,sumIng - sumEgr);
}

async function editMovement(id){
  if(!session || !session.turnId) return alert('No hay sesi√≥n/turno.');
  const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
  const docPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos/${id}`;
  const snap = await getDoc(doc(db, docPath));
  if(!snap.exists()) return alert('Movimiento no encontrado.');
  const m = snap.data();
  if(!(session && (session.userId===m.createdBy || session.name==='Jair P√©rez' || (session.roles && session.roles.includes('direccion'))))) return alert('No tienes permiso para editar.');
  const newMonto = Math.round(parseFloat(prompt('Nuevo monto', m.monto)) || m.monto);
  const newNota = prompt('Nueva nota', m.nota || '') || m.nota;
  const newConcept = prompt('Nuevo concepto', m.concepto) || m.concepto;
  try{
    await updateDoc(doc(db, docPath), { monto: Number(newMonto), nota:newNota, concepto:newConcept });
    refreshTurnHistory();
  }catch(e){ console.error('Error editando movimiento', e); alert('No se pudo editar.'); }
}

async function deleteMovement(id){
  if(!confirm('Eliminar movimiento?')) return;
  if(!session || !session.turnId) return alert('No hay sesi√≥n/turno.');
  const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
  const docPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos/${id}`;
  const snap = await getDoc(doc(db, docPath));
  if(!snap.exists()) return alert('No encontrado.');
  const m = snap.data();
  if(m.protected) return alert('Este movimiento fue marcado como "Otro" y no puede eliminarse. Solo puede editarse.');
  if(!(session && (session.userId===m.createdBy || session.name==='Jair P√©rez' || (session.roles && session.roles.includes('direccion'))))) return alert('No tienes permiso para eliminar.');
  try{
    await deleteDoc(doc(db, docPath));
    refreshTurnHistory();
  }catch(e){ console.error('Error eliminando', e); alert('No se pudo eliminar.'); }
}

/* Sales */
function clearSaleForm(){ document.getElementById('ventaCliente').value=''; document.getElementById('ventaMatricula').value=''; document.getElementById('ventaDescripcion').value=''; document.getElementById('ventaMonto').value=''; document.getElementById('ventaDescuento').value='0'; }

async function registerSale(opts){
  opts = opts || {};
  const client = document.getElementById('ventaCliente').value.trim();
  const matricula = document.getElementById('ventaMatricula').value.trim();
  const desc = document.getElementById('ventaDescripcion').value.trim() || 'Venta';
  const montoWithIvaRaw = parseFloat(document.getElementById('ventaMonto').value) || 0;
  const descuentoRaw = parseFloat(document.getElementById('ventaDescuento').value) || 0;
  if(!client) return alert('Ingresa el nombre del alumno/cliente.');
  if(montoWithIvaRaw <= 0) return alert('Monto inv√°lido.');
  const montoWithIva = Math.round(montoWithIvaRaw);
  const baseOriginal = Number((montoWithIva / 1.16).toFixed(2));
  const baseAfterDiscount = Number(Math.max(0, (baseOriginal - descuentoRaw)).toFixed(2));
  const iva = Number((baseAfterDiscount * 0.16).toFixed(2));
  const total = Number(Math.round((baseAfterDiscount + iva)));
  // id compra
  const nowD = new Date(); const dd=String(nowD.getDate()).padStart(2,'0'); const mm=String(nowD.getMonth()+1).padStart(2,'0'); const yyyy=nowD.getFullYear(); const hh=String(nowD.getHours()).padStart(2,'0'); const min=String(nowD.getMinutes()).padStart(2,'0'); const ss=String(nowD.getSeconds()).padStart(2,'0');
  const idCompra = `${dd}${mm}${yyyy}-${hh}${min}${ss}`;
  const sale = {
    id: idCompra,
    cliente: client,
    matricula,
    descripcion: desc,
    montoWithIva,
    descuento: Number(descuentoRaw.toFixed(2)),
    base: baseAfterDiscount,
    iva,
    total,
    paymentMethod: opts.card ? 'tarjeta' : 'efectivo',
    createdAt: new Date().toISOString(),
    usuario: session ? session.name : '-',
    turno: session ? session.turnId : '-'
  };
  try{
    // store under turn if exists
    if(session && session.turnId){
      const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
      const ventasPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}/ventas`;
      if(!opts.card){
        // add simultaneous movimiento ingreso
        const move = { id: uid('m'), turnoId: session.turnId, createdBy: session.userId, creatorName: session.name, tipo: 'ingreso', metodo:'efectivo', concepto: desc, nota:`Venta - ${client} - Mat: ${matricula||'-'}`, monto: sale.total, createdAt: new Date().toISOString(), protected:false };
        await setDoc(doc(db, ventasPath, sale.id), sale);
        await setDoc(doc(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos`, move.id), move);
      } else {
        await setDoc(doc(db, ventasPath, sale.id), sale);
      }
    } else {
      // no turn, store under TRANS
      const now = new Date();
      const p = partsFromDate(now);
      const ventasPath = `years/${p.year}/months/${p.month}/days/${p.day}/turnos/TRANS/ventas`;
      await setDoc(doc(db, ventasPath, sale.id), sale);
    }
    printSaleTicket(sale);
    clearSaleForm();
    refreshTurnHistory();
  }catch(e){ console.error('Error guardando venta', e); alert('No se pudo guardar la venta. Revisa conexi√≥n.'); }
}

function printSaleTicket(sale){
  const ticketHtml = `
    <div class="ticket" style="width:270px;padding:18px;font-family:Arial,Helvetica,sans-serif;">
      <div style="text-align:center;font-weight:800;font-size:15px">eVocal Studio</div>
      <div style="text-align:center;font-size:12px;margin-top:6px">Comprobante de Pago ‚Äî ${sale.paymentMethod === 'tarjeta' ? 'Tarjeta' : 'Efectivo'}</div>
      <div class="dots">........................................</div>
      <div style="font-size:13px">Alumno: <strong>${sale.cliente}</strong></div>
      <div style="font-size:13px">Matr√≠cula: <strong>${sale.matricula || '-'}</strong></div>
      <div style="font-size:13px">Atendido por: <strong>${sale.usuario || '-'}</strong></div>
      <div style="font-size:13px">Fecha: <strong>${fmtShort(sale.createdAt)} ${fmtTime(sale.createdAt)}</strong></div>
      <div style="font-size:13px">ID Compra: <strong>${sale.id}</strong></div>
      <div class="dots">........................................</div>
      <div style="font-size:13px">Descripci√≥n: <strong>${sale.descripcion}</strong></div>
      <div style="border-top:1px dashed #ddd;margin-top:8px;padding-top:8px">
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div>Venta neta</div><div>${money(sale.base)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div>Descuento</div><div>${money(sale.descuento)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div>IVA (16%)</div><div>${money(sale.iva)}</div></div>
        <div style="border-top:1px solid #000;margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;font-weight:800"><div>TOTAL</div><div>${money(sale.total)}</div></div>
      </div>
      <div class="dots" style="margin-top:10px">........................................</div>
      <div style="font-size:10px;color:#444;white-space:pre-wrap">Comprobante v√°lido por el pago en efectivo. En caso de requerir factura, env√≠e sus datos a: info@evocalstudio.com</div>
      <div class="dots" style="margin-top:8px">........................................</div>
      <div style="text-align:center;font-size:11px;color:#444">eVocal Studio</div>
    </div>
  `;
  const w = window.open('','saleTicket'); w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Ticket venta</title><style>body{font-family:Arial;margin:0;padding:8px}.ticket{width:270px;padding:12px}.dots{text-align:center;color:#666;letter-spacing:1px;margin:8px 0}</style></head><body>');
  w.document.write(ticketHtml); w.document.close(); setTimeout(()=>w.print(),400);
}

/* Close turn & printing (cierres) */
async function closeTurn(){
  if(!session || !session.turnId) return alert('No hay turno abierto o no est√°s autenticado.');
  const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
  const turnDocPath = `years/${year}/months/${month}/days/${day}/turnos/${turno}`;
  const turnRef = doc(db, turnDocPath);
  const turnSnap = await getDoc(turnRef);
  if(!turnSnap.exists()) return alert('Turno no encontrado.');
  const turnData = turnSnap.data();
  const isOwner = session.userId === turnData.encargadoId;
  if(!isOwner){
    const pin = prompt('PIN de Encargado/Direcci√≥n:'); if(!pin) return; const auth = await findUserByPin(pin); if(!auth || !(auth.roles.includes('encargado')||auth.roles.includes('direccion')||auth.name==='Jair P√©rez')) return alert('PIN inv√°lido.');
  } else if(!confirm('¬øDeseas cerrar tu turno?')) return;

  // compute final delivered
  const movColl = collection(db, `${turnDocPath}/movimientos`);
  const movSnap = await getDocs(movColl);
  let finalDelivered = 0;
  movSnap.docs.forEach(d=>{ const m = d.data(); finalDelivered += (m.tipo==='ingreso'?m.monto:-m.monto); });
  const closedAt = new Date().toISOString();

  try{
    await updateDoc(turnRef, { status:'closed', closedAt, closedBy: session?session.name:'', closedDelivered: Number(finalDelivered.toFixed(2)) });
    await setDoc(doc(db, `${turnDocPath}/cierres`, 'summary'), { closedAt, closedBy: session?session.name:'', closedDelivered: Number(finalDelivered.toFixed(2)), finalizedAt: new Date().toISOString() });
    alert('Turno cerrado. Monto final entregado: ' + money(finalDelivered));
    refreshAll();
    setTimeout(()=>printTicket(),400);
  }catch(e){ console.error('Error cerrando turno', e); alert('No se pudo cerrar turno.'); }
}

async function printTicket(){
  // pick most relevant turn: today's closed or open
  const now = new Date();
  const p = partsFromDate(now);
  const dayTurnsPath = `years/${p.year}/months/${p.month}/days/${p.day}/turnos`;
  try{
    const turnListSnap = await getDocs(collection(db, dayTurnsPath));
    let candidate = null;
    turnListSnap.docs.forEach(d=>{ const data=d.data(); if(data.status==='closed') candidate = { id:createTurnId(now,data.shift), data, ref:d.ref }; });
    if(!candidate) turnListSnap.docs.forEach(d=>{ const data=d.data(); if(data.status==='open') candidate = { id:createTurnId(now,data.shift), data, ref:d.ref }; });
    if(!candidate) return alert('No hay turno para imprimir.');
    const turnId = candidate.id;
    const turno = candidate.ref.id;
    const movSnap = await getDocs(collection(db, `${dayTurnsPath}/${turno}/movimientos`));
    const moves = movSnap.docs.map(d=>d.data());
    let efectivo=0, ingresos=0, egresos=0;
    moves.forEach(m=>{ efectivo += (m.tipo==='ingreso'?m.monto:-m.monto); if(m.tipo==='ingreso') ingresos+=m.monto; if(m.tipo==='egreso') egresos+=m.monto; });
    const opened = new Date(candidate.data.openedAt || new Date());
    const closed = candidate.data.closedAt ? new Date(candidate.data.closedAt) : new Date();
    const diffMs = Math.max(0, closed.getTime() - opened.getTime()); const totalMin = Math.floor(diffMs/60000); const hh = Math.floor(totalMin/60); const mm = totalMin%60;
    const hoursText = `${hh} h ${mm} min`;
    const dots='........................................';
    const ticketHtml = `
    <div class="ticket" style="width:270px;padding:18px;font-family:Arial,Helvetica,sans-serif;font-weight:700;">
      <div style="text-align:center;font-weight:800;font-size:16px">eVocal Studio</div>
      <div style="text-align:center;font-size:12px;margin-top:6px">Corte de Caja</div>
      <div class="dots">${dots}</div>

      <div style="font-size:13px">Fecha: <strong>${turnId.slice(0,2)}/${turnId.slice(2,4)}/${turnId.slice(4,8)}</strong></div>
      <div style="font-size:13px">Turno: <strong>${candidate.data.shift==='M'?'Matutino':'Vespertino'}</strong></div>
      <div class="dots">${dots}</div>

      <div style="margin-top:6px; font-weight:700;">
        ${moves.map(m=>`<div style="display:flex;justify-content:space-between;padding:12px 0;font-weight:700"><div style="max-width:160px;text-align:left">${m.concepto}</div><div style="min-width:90px;text-align:${m.tipo==='ingreso'?'right':'left'}">${m.tipo==='ingreso'? '+' : '-'} ${money(m.monto)}</div></div>`).join('')}
      </div>

      <div class="dots">${dots}</div>

      <div style="display:flex;justify-content:space-between;font-weight:800;padding:8px 0;font-size:13px"><div>Total efectivo</div><div>${money(efectivo)}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px"><div><strong>Total ingresos</strong></div><div>${money(ingresos)}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px"><div><strong>Total egresos</strong></div><div>${money(egresos)}</div></div>

      <div class="dots">${dots}</div>
      <div style="font-size:13px;font-weight:800">Horas abiertas de la caja: <strong>${hoursText}</strong></div>

      <div style="margin-top:36px;text-align:center">
        <div class="signature-line"></div>
        <div class="centered-caption">Entregado por</div>
      </div>

      <div style="margin-top:36px;text-align:center">
        <div class="signature-line"></div>
        <div class="centered-caption">Recibido por</div>
      </div>

      <div class="dots" style="margin-top:12px">${dots}</div>

      <div class="footer-legal">
eVocal Studio

Declaraci√≥n de Responsabilidad y Confidencialidad

Al firmar este comprobante, confirmo que he recibido la caja correspondiente al turno asignado, verificando que los montos entregados y registrados coinciden con el efectivo f√≠sico en resguardo.

Me comprometo a manejar los recursos bajo mi responsabilidad con total transparencia, honestidad y apego a las pol√≠ticas internas de eVocal Studio, quedando estrictamente prohibido el uso personal, pr√©stamo o retenci√≥n de fondos sin autorizaci√≥n previa.

Reconozco que cualquier diferencia detectada en los montos, movimientos irregulares o errores en el registro deber√°n ser reportados inmediatamente al Encargado o a Direcci√≥n para su revisi√≥n.

Este documento constituye un acuerdo de confidencialidad y responsabilidad administrativa, y su firma acredita la correcta entrega y recepci√≥n de los valores, as√≠ como el cumplimiento de las obligaciones operativas del puesto.

Uso exclusivo de eVocal Studio.
      </div>
    </div>`;
    const w = window.open('','ticketPrint'); w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Ticket</title><style>body{font-family:Arial;margin:0;padding:8px}.ticket{width:270px;padding:12px}.dots{text-align:center;color:#666;letter-spacing:1px;margin:8px 0}</style></head><body>');
    w.document.write(ticketHtml); w.document.close(); setTimeout(()=>w.print(),400);
  }catch(e){
    console.error('Error obteniendo turno para imprimir', e); alert('No se pudo obtener turno para imprimir.');
  }
}

/* Denominations */
async function calculateDenominations(){
  const v1000 = parseInt(document.getElementById('d1000')?.value)||0;
  const v500 = parseInt(document.getElementById('d500')?.value)||0;
  const v200 = parseInt(document.getElementById('d200')?.value)||0;
  const v100 = parseInt(document.getElementById('d100')?.value)||0;
  const v50 = parseInt(document.getElementById('d50')?.value)||0;
  const v20 = parseInt(document.getElementById('d20')?.value)||0;
  const v10 = parseInt(document.getElementById('d10')?.value)||0;
  const v5 = parseInt(document.getElementById('d5')?.value)||0;
  const v2 = parseInt(document.getElementById('d2')?.value)||0;
  const v1 = parseInt(document.getElementById('d1')?.value)||0;
  const v050 = parseInt(document.getElementById('d050')?.value)||0;
  const total = v1000*1000 + v500*500 + v200*200 + v100*100 + v50*50 + v20*20 + v10*10 + v5*5 + v2*2 + v1*1 + v050*0.5;
  document.getElementById('totalCounted') && (document.getElementById('totalCounted').innerText = money(total));
  let declared = 0;
  if(session && session.turnId){
    const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
    const movSnap = await getDocs(collection(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}/movimientos`));
    movSnap.docs.forEach(d=>{ const m = d.data(); declared += (m.tipo==='ingreso'?m.monto:-m.monto); });
  }
  document.getElementById('efectivoDeclarado') && (document.getElementById('efectivoDeclarado').innerText = money(declared));
  document.getElementById('diferenciaEfectivo') && (document.getElementById('diferenciaEfectivo').innerText = money(total - declared));
  return total;
}
async function saveDenominations(){
  if(!session || !session.turnId) return alert('No hay turno abierto.');
  const total = await calculateDenominations();
  const day = session.turnId.slice(0,2), month = session.turnId.slice(2,4), year = session.turnId.slice(4,8), turno = session.turnId.slice(8);
  try{
    await setDoc(doc(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}/denoms`, 'count'), { total, savedAt: new Date().toISOString(), by: session?session.name:'-' });
    alert('Conteo guardado.');
  }catch(e){ console.warn('No se pudo guardar conteo', e); alert('No se pudo guardar conteo en la nube.'); }
}

/* Reset general (master pin 1417) */
async function resetGeneral(){
  const pin = prompt('Reset general ‚Äî ingresa PIN maestro:');
  if(!pin) return; if(pin !== '1417') return alert('PIN maestro inv√°lido.');
  if(!confirm('Confirmar Reset General: se BORRAR√ÅN movimientos, ventas y cierres. Esta acci√≥n NO puede deshacerse.')) return;
  try{
    // iterate tree and remove documents but keep users collection
    const yearsSnap = await getDocs(collection(db,'years'));
    for(const ydoc of yearsSnap.docs){
      const monthsSnap = await getDocs(collection(db, `years/${ydoc.id}/months`));
      for(const mdoc of monthsSnap.docs){
        const daysSnap = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days`));
        for(const ddoc of daysSnap.docs){
          const turnosSnap = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos`));
          for(const tdoc of turnosSnap.docs){
            const movs = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/movimientos`));
            for(const md of movs.docs) await deleteDoc(md.ref);
            const vts = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/ventas`));
            for(const vd of vts.docs) await deleteDoc(vd.ref);
            const den = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/denoms`));
            for(const dd of den.docs) await deleteDoc(dd.ref);
            const csum = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/cierres`));
            for(const cd of csum.docs) await deleteDoc(cd.ref);
            await deleteDoc(tdoc.ref);
          }
          await deleteDoc(ddoc.ref);
        }
        await deleteDoc(mdoc.ref);
      }
      await deleteDoc(ydoc.ref);
    }
    alert('Reset general realizado. Movimientos, ventas y cierres eliminados en Firestore.');
    refreshAll();
  }catch(e){ console.error('Error reset general', e); alert('No se pudo realizar reset general.'); }
}

/* Reports (daily/monthly/annual) */
async function exportDailyReport(){
  const id = prompt('Reporte diario - ingresa ID de turno (DDMMAAAATURNO) o deja vac√≠o para el √∫ltimo cerrado del d√≠a:');
  let turnDoc = null;
  if(id){
    const day = id.slice(0,2), month = id.slice(2,4), year = id.slice(4,8), turno = id.slice(8);
    turnDoc = { id, ref: doc(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}`), data: (await getDoc(doc(db, `years/${year}/months/${month}/days/${day}/turnos/${turno}`))).data() };
    if(!turnDoc.data) return alert('Turno no encontrado.');
  } else {
    const now = new Date();
    const { year, month, day } = partsFromDate(now);
    const turnsColl = collection(db, `years/${year}/months/${month}/days/${day}/turnos`);
    const snap = await getDocs(turnsColl);
    if(snap.empty) return alert('No hay turnos hoy.');
    let closed = null;
    snap.docs.forEach(d=>{ const data=d.data(); if(data.status==='closed') closed = { id:createTurnId(now,data.shift), data, ref:d.ref }; });
    if(!closed) snap.docs.forEach(d=>{ const data=d.data(); if(data.status==='open') closed = { id:createTurnId(now,data.shift), data, ref:d.ref }; });
    if(!closed) return alert('No hay turnos disponibles.');
    turnDoc = closed;
  }
  const movSnap = await getDocs(collection(turnDoc.ref, 'movimientos'));
  const moves = movSnap.docs.map(d=>d.data());
  const ingresos = moves.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+m.monto,0);
  const egresos = moves.filter(m=>m.tipo==='egreso').reduce((s,m)=>s+m.monto,0);
  const balance = ingresos - egresos;
  const opened = new Date(turnDoc.data.openedAt); const closed = turnDoc.data.closedAt ? new Date(turnDoc.data.closedAt) : new Date();
  const diffMs = Math.max(0, closed.getTime() - opened.getTime()); const totalMin = Math.floor(diffMs/60000); const hh = Math.floor(totalMin/60); const mm = totalMin%60;
  const hoursText = `${hh}h ${mm}m`;
  let html = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte Diario ${turnDoc.id}</title><style>body{font-family:Arial;padding:18px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}th{background:#f0f0f0}</style></head><body>`;
  html += `<h2>Reporte Diario ‚Äî Turno ${turnDoc.id}</h2>`;
  html += `<div>Encargado: <strong>${turnDoc.data.encargadoName}</strong> ‚Äî Turno: ${turnDoc.data.shift==='M'?'Matutino':'Vespertino'}</div>`;
  html += `<div>Abierto: ${turnDoc.data.openedAt ? new Date(turnDoc.data.openedAt).toLocaleString() : '-'} ${turnDoc.data.closedAt? ' ‚Äî Cerrado: ' + new Date(turnDoc.data.closedAt).toLocaleString() : ''}</div>`;
  html += `<div style="margin-top:8px;font-weight:700">Horas abiertas: ${hoursText}</div>`;
  html += `<h3 style="margin-top:14px">Resumen</h3>`;
  html += `<table><tr><th>Total ingresos</th><th>Total egresos</th><th>Balance</th><th>Movimientos</th></tr>`;
  html += `<tr><td>${money(ingresos)}</td><td>${money(egresos)}</td><td>${money(balance)}</td><td>${moves.length}</td></tr></table>`;
  html += `<h3 style="margin-top:14px">Detalle de movimientos</h3>`;
  html += `<table><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Nota</th><th style="text-align:right">Monto</th></tr>`;
  moves.forEach(m=> html += `<tr><td>${new Date(m.createdAt).toLocaleString()}</td><td>${m.tipo}</td><td>${m.concepto}</td><td>${(m.nota||'')}</td><td style="text-align:right">${money(m.monto)}</td></tr>`);
  html += `</table><div style="margin-top:16px;color:#666;font-size:12px">Generado: ${new Date().toLocaleString()}</div></body></html>`;
  const w = window.open('','rep'); w.document.write(html); w.document.close();
}

async function exportMonthlyReport(){
  const ym = prompt('Reporte mensual - ingresa YYYY-MM (vac√≠o = mes actual)');
  const target = ym ? new Date(ym+'-01T00:00:00') : new Date();
  if(isNaN(target.getTime())) return alert('Formato inv√°lido.');
  const month = String(target.getMonth()+1).padStart(2,'0'); const year = String(target.getFullYear());
  const daysSnap = await getDocs(collection(db, `years/${year}/months/${month}/days`));
  let included = [];
  for(const ddoc of daysSnap.docs){
    const turnosSnap = await getDocs(collection(db, `years/${year}/months/${month}/days/${ddoc.id}/turnos`));
    for(const tdoc of turnosSnap.docs){
      const movs = await getDocs(collection(db, `years/${year}/months/${month}/days/${ddoc.id}/turnos/${tdoc.id}/movimientos`));
      movs.docs.forEach(md=> included.push(md.data()));
    }
  }
  if(included.length===0) return alert('No hay movimientos en ese mes.');
  const ingresos = included.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+m.monto,0);
  const egresos = included.filter(m=>m.tipo==='egreso').reduce((s,m)=>s+m.monto,0);
  const balance = ingresos - egresos;
  let html = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte mensual ${month}-${year}</title><style>body{font-family:Arial;padding:18px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}th{background:#f0f0f0}</style></head><body>`;
  html += `<h2>Reporte Mensual ‚Äî ${month}/${year}</h2>`;
  html += `<table><tr><th>Total ingresos</th><th>Total egresos</th><th>Balance</th><th>Movimientos</th></tr>`;
  html += `<tr><td>${money(ingresos)}</td><td>${money(egresos)}</td><td>${money(balance)}</td><td>${included.length}</td></tr></table>`;
  html += `<div style="margin-top:12px;color:#666;font-size:12px">Generado: ${new Date().toLocaleString()}</div></body></html>`;
  const w = window.open('','repmonth'); w.document.write(html); w.document.close();
}

async function exportAnnualReport(){
  const yy = prompt('Reporte anual - ingresa YYYY (vac√≠o = a√±o actual)');
  const year = yy ? String(yy) : String(new Date().getFullYear());
  const monthsSnap = await getDocs(collection(db, `years/${year}/months`));
  let included = [];
  for(const mdoc of monthsSnap.docs){
    const daysSnap = await getDocs(collection(db, `years/${year}/months/${mdoc.id}/days`));
    for(const ddoc of daysSnap.docs){
      const turnosSnap = await getDocs(collection(db, `years/${year}/months/${mdoc.id}/days/${ddoc.id}/turnos`));
      for(const tdoc of turnosSnap.docs){
        const movs = await getDocs(collection(db, `years/${year}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/movimientos`));
        movs.docs.forEach(md=> included.push(md.data()));
      }
    }
  }
  if(included.length===0) return alert('No hay movimientos en ese a√±o.');
  const ingresos = included.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+m.monto,0);
  const egresos = included.filter(m=>m.tipo==='egreso').reduce((s,m)=>s+m.monto,0);
  const balance = ingresos - egresos;
  let html = `<!doctype html><html><head><meta charset="utf-8"><title>Reporte anual ${year}</title><style>body{font-family:Arial;padding:18px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}th{background:#f0f0f0}</style></head><body>`;
  html += `<h2>Reporte Anual ‚Äî ${year}</h2>`;
  html += `<table><tr><th>Total ingresos</th><th>Total egresos</th><th>Balance</th><th>Movimientos</th></tr>`;
  html += `<tr><td>${money(ingresos)}</td><td>${money(egresos)}</td><td>${money(balance)}</td><td>${included.length}</td></tr></table>`;
  html += `<div style="margin-top:12px;color:#666;font-size:12px">Generado: ${new Date().toLocaleString()}</div></body></html>`;
  const w = window.open('','repyear'); w.document.write(html); w.document.close();
}

/* Users & forgot */
async function createUser(){
  const name=document.getElementById('newName').value.trim(); const role=document.getElementById('newRole').value; const pin=document.getElementById('newPin').value.trim();
  if(!name||!pin) return alert('Nombre y PIN son requeridos.'); if(!/^\d{4,8}$/.test(pin)) return alert('PIN debe ser num√©rico (4-8 d√≠gitos).');
  const q = query(collection(db,'users'), where('name','==',name));
  const snap = await getDocs(q);
  if(!snap.empty) return alert('Ya existe usuario con ese nombre.');
  try{ await addDoc(collection(db,'users'), { name, roles:[role], pin }); document.getElementById('newName').value=''; document.getElementById('newPin').value=''; loadUsers(); alert('Usuario creado.'); }catch(e){ console.error('Error creando usuario', e); alert('No se pudo crear usuario.'); }
}

async function loadUsers(){
  const snap = await getDocs(collection(db,'users'));
  const users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  const el=document.getElementById('usersList');
  el.innerHTML = users.map(u=>`<div style="padding:8px;border-bottom:1px dashed ${getComputedStyle(document.documentElement).getPropertyValue('--border')}"><strong>${u.name}</strong><div class="small-muted">${(u.roles||[]).join(', ')}</div></div>`).join('')||'<em>No hay usuarios</em>';
}
loadUsers();

async function requestForgot(){
  const name=document.getElementById('forgotName').value.trim();
  const reason=document.getElementById('forgotReason').value.trim();
  if(!name||!reason) return alert('Completa campos.');
  const q = query(collection(db,'users'), where('name','==',name));
  const snap = await getDocs(q);
  if(snap.empty) return alert('Usuario no encontrado.');
  const u = snap.docs[0].data();
  const req = { userId: snap.docs[0].id, userName: u.name, reason, requestedBy: u.name, ts: new Date().toISOString(), type:'forgot' };
  try{ await addDoc(collection(db,'reset_requests'), req); document.getElementById('forgotName').value=''; document.getElementById('forgotReason').value=''; loadResetRequests(); alert('Solicitud enviada.'); }catch(e){ console.error('Error request forgot', e); alert('No se pudo enviar solicitud.'); }
}
async function loadResetRequests(){ const snap = await getDocs(collection(db,'reset_requests')); const reqs = snap.docs.map(d=>({ id:d.id, ...d.data() })); const el=document.getElementById('resetRequests'); if(reqs.length===0) el.innerHTML='<em>Sin solicitudes</em>'; else el.innerHTML = reqs.map(r=>`<div style="padding:8px;border-bottom:1px dashed ${getComputedStyle(document.documentElement).getPropertyValue('--border')}"><strong>${r.userName}</strong> ‚Äî ${r.type}<div class="small-muted">Solicitado: ${new Date(r.ts).toLocaleString()}</div></div>`).join(''); }
loadResetRequests();

/* Countdown */
function msUntil(target){ return Math.max(0, new Date(target).getTime() - new Date().getTime()); }
function formatRemaining(ms){ const totalMin = Math.floor(ms/60000); const h=Math.floor(totalMin/60); const m = totalMin%60; return `${h}h ${m}m`; }
function updateCountdown(){
  const s = detectShift(new Date());
  const el = document.getElementById('shiftTimer');
  if(s==='M'){ const end = new Date(); end.setHours(15,0,0,0); el.textContent = `‚è∞ Tiempo para corte (fin Matutino): ${formatRemaining(msUntil(end))}`; }
  else if(s==='V'){ const end = new Date(); end.setHours(21,0,0,0); el.textContent = `‚è∞ Tiempo para corte (fin Vespertino): ${formatRemaining(msUntil(end))}`; }
  else el.textContent = `‚è∞ Fuera de horario de turnos`;
}
setInterval(updateCountdown,1000); updateCountdown();

/* Refresh history */
async function refreshTurnHistory(){
  const now = new Date();
  const { year } = partsFromDate(now);
  const monthsSnap = await getDocs(collection(db, `years/${year}/months`));
  let turns = [];
  for(const mdoc of monthsSnap.docs){
    const daysSnap = await getDocs(collection(db, `years/${year}/months/${mdoc.id}/days`));
    for(const ddoc of daysSnap.docs){
      const turnosSnap = await getDocs(collection(db, `years/${year}/months/${mdoc.id}/days/${ddoc.id}/turnos`));
      for(const tdoc of turnosSnap.docs){
        const data = tdoc.data();
        const tid = `${ddoc.id}${mdoc.id}${year}${tdoc.id}`;
        turns.push({ id: tid, ...data, ref: tdoc.ref });
      }
    }
  }
  turns.sort((a,b)=> new Date(b.openedAt || 0) - new Date(a.openedAt || 0));
  const el = document.getElementById('turnHistory');
  if(turns.length===0){ el.innerHTML='<em>No hay turnos</em>'; return; }
  el.innerHTML = turns.map(t=>`<div style="padding:8px;border-bottom:1px dashed ${getComputedStyle(document.documentElement).getPropertyValue('--border')};"><div style="display:flex;justify-content:space-between"><div><strong>${t.id}</strong> ‚Äî ${t.shift==='M'?'Matutino':'Vespertino'}</div><div>${(t.status||'').toUpperCase()}</div></div><div class="small-muted">Encargado: ${t.encargadoName} ‚Äî Abierto: ${t.openedAt?new Date(t.openedAt).toLocaleString():''} ${t.closedAt? ' ‚Äî Cerrado: ' + new Date(t.closedAt).toLocaleString():''}</div></div>`).join('');
}

/* CSV export (simple) */
async function exportCSV(){
  const yearsSnap = await getDocs(collection(db,'years'));
  let rows = ['turnId,turnDate,shift,encargado,moveId,type,concept,amount,createdBy,createdAt'];
  for(const ydoc of yearsSnap.docs){
    const monthsSnap = await getDocs(collection(db, `years/${ydoc.id}/months`));
    for(const mdoc of monthsSnap.docs){
      const daysSnap = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days`));
      for(const ddoc of daysSnap.docs){
        const turnosSnap = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos`));
        for(const tdoc of turnosSnap.docs){
          const data = tdoc.data();
          const tid = `${ddoc.id}${mdoc.id}${ydoc.id}${tdoc.id}`;
          const movSnap = await getDocs(collection(db, `years/${ydoc.id}/months/${mdoc.id}/days/${ddoc.id}/turnos/${tdoc.id}/movimientos`));
          if(movSnap.empty) rows.push(`${tid},${data.openedAt||''},${data.shift},${data.encargadoName},,,,,,`);
          else movSnap.docs.forEach(m=> rows.push([tid,data.openedAt,data.shift,data.encargadoName,m.id,m.data().tipo,`"${(m.data().concepto||'').replace(/"/g,'""')}"`,m.data().monto,m.data().creatorName,m.data().createdAt].join(',')));
        }
      }
    }
  }
  const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='caja_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

/* UI helpers */
function updateSums(ef,ing,egr,balance){ document.getElementById('sumEfectivo').innerText = money(ef); document.getElementById('sumIngresos').innerText = money(ing); document.getElementById('sumEgresos').innerText = money(egr); document.getElementById('sumBalance').innerText = money(balance); }

function updateUIForSession(){
  const logged = !!session;
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.querySelector('.tab[data-tab="access"]').style.display='';
  if(logged){
    document.querySelector('.tab[data-tab="cash"]').style.display='';
    document.querySelector('.tab[data-tab="venta"]').style.display='';
    document.querySelector('.tab[data-tab="calc"]').style.display='';
    document.querySelector('.tab[data-tab="forgot"]').style.display='';
    document.querySelector('.tab[data-tab="history"]').style.display='';
    if(session.roles && (session.roles.includes('direccion')||session.roles.includes('encargado')||session.name==='Jair P√©rez')) document.querySelector('.tab[data-tab="users"]').style.display='';
  }
  if(session) document.getElementById('userDisplay').textContent = session.name; else document.getElementById('userDisplay').textContent = 'No autenticado';
  if(!session){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('.tab[data-tab="access"]').classList.add('active');
    document.getElementById('tab-access').style.display='';
    document.getElementById('tab-cash').style.display='none';
    document.getElementById('tab-venta').style.display='none';
    document.getElementById('tab-calc').style.display='none';
    document.getElementById('tab-usersCard').style.display='none';
    document.getElementById('tab-forgotCard').style.display='none';
    document.getElementById('tab-historyCard').style.display='none';
  }
  refreshAll();
}

async function refreshAll(){
  displayShift();
  if(session && session.turnId) {
    if(!movementsUnsub) subscribeRealtime(session.turnId);
  }
  await refreshTurnHistory();
  loadUsers();
  loadResetRequests();
}

/* small helpers */
function simulateTime(){ const v=prompt('Ingresa fecha-hora ISO (ej: 2025-11-06T10:00) o vac√≠o para real'); if(v) alert('La aplicaci√≥n usa la hora local del equipo. Simulaci√≥n solo informativa.'); }
function goToForgot(){ tabs.forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab="forgot"]').classList.add('active'); document.getElementById('tab-access').style.display='none'; document.getElementById('tab-forgotCard').style.display=''; }

/* init */
updateUIForSession();
console.log('Interfaz lista. Sirve por HTTP para que Firebase funcione correctamente.');
</script>
</body>
</html>
